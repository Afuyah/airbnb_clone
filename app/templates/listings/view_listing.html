{% extends 'base.html' %}

{% block content %}
<div class="container listing-detail mt-5">

    <!-- Listing Title and Price -->
    <div class="row">
        <div class="col-md-8">
            <h1 class="display-4">{{ listing.title }}</h1>
            <p class="lead text-muted">{{ listing.location.name }}</p>
        </div>
        <div class="col-md-4 text-right">
            <h2 class="text-success">Ksh. {{ listing.price_per_night }} <small>per night</small></h2>
        </div>
    </div>

    <!-- Image Slider -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="swiper-container shadow-sm rounded">
                <div class="swiper-wrapper">
                    {% if listing.images %}
                        {% for image in listing.images %}
                            <div class="swiper-slide">
                                <img src="{{ image.url }}" class="img-fluid rounded" alt="{{ listing.title }}" loading="lazy">
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="swiper-slide">
                            <img src="{{ url_for('static', filename='images/default-image.jpg') }}" class="img-fluid rounded" alt="Default Image" loading="lazy">
                        </div>
                    {% endif %}
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </div>
    </div>

    <!-- Listing Description and Amenities -->
    <div class="row mt-5">
        <div class="col-md-8">
            <h3 class="mb-4">About this Listing</h3>
            <p>{{ listing.description }}</p>

            <h4 class="mt-5">Amenities</h4>
            <ul class="list-inline animated fadeIn">
                {% for amenity in listing.amenities %}
                    <li class="list-inline-item badge badge-light p-2 mb-2">{{ amenity.name }}</li>
                {% else %}
                    <li class="list-inline-item">No amenities listed.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Booking Section -->
        <div class="col-md-4">
            <div class="card shadow-sm p-3 mb-4 fadeIn sticky-top">
                <h4 class="text-center">Book this Listing</h4>
                <form action="{{ url_for('bookings.book_listing', listing_id=listing.id) }}" method="POST" class="mt-3">
                    {{ booking_form.hidden_tag() }}
                    <div class="form-group">
                        {{ booking_form.check_in_date.label(class="form-label") }}
                        {{ booking_form.check_in_date(class="form-control", data='input', placeholder="Select check-in date") }}
                    </div>
                    <div class="form-group">
                        {{ booking_form.check_out_date.label(class="form-label") }}
                        {{ booking_form.check_out_date(class="form-control", data='input', placeholder="Select check-out date") }}
                    </div>
                    <div class="text-center">
                        {{ booking_form.submit(class="btn btn-success btn-block") }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Related Listings -->
    <div class="row mt-5">
        <div class="col-12">
            <h3>Related Listings</h3>
            <div class="row">
                {% for related in related_listings %}
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm transition-transform">
                            {% if related.images %}
                                <img src="{{ related.images[0].url }}" class="card-img-top img-fluid" alt="{{ related.title }}" loading="lazy">
                            {% else %}
                                <img src="{{ url_for('static', filename='images/default-image.jpg') }}" class="card-img-top img-fluid" alt="Default Image" loading="lazy">
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{ related.title }}</h5>
                                <p class="card-text text-muted">{{ related.location.name }}</p>
                                <p class="text-success">Ksh. {{ related.price_per_night }} per night</p>
                                <a href="{{ url_for('listings.view_listing', listing_id=related.id) }}" class="btn btn-primary btn-block">View Details</a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p>No related listings available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Swiper.js and Flatpickr Script -->
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    // Initialize Flatpickr for date inputs
    flatpickr("[data-input]", {
        dateFormat: "Y-m-d",
        minDate: "today",
    });

    // Initialize Swiper
    var swiper = new Swiper('.swiper-container', {
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        loop: true,
        autoplay: {
            delay: 5000,
            disableOnInteraction: false,
        },
        lazy: true, // Lazy loading for better performance
    });

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
        });
    });
</script>

<!-- Custom Styles -->
<style>
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --background-color: #f8f9fa;
        --text-color: #2c3e50;
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: 'Roboto', sans-serif;
    }

    h1, h2 {
        font-family: 'Montserrat', sans-serif;
        color: var(--text-color);
    }

    .listing-detail h1, .listing-detail h2 {
        font-weight: 700;
    }

    .swiper-container {
        width: 100%;
        height: 500px;
    }

    .swiper-slide img {
        object-fit: cover;
        width: 100%;
        height: 100%;
        border-radius: 10px;
        transition: transform 0.3s ease;
    }

    .swiper-slide img:hover {
        transform: scale(1.05);
    }

    .badge-light {
        background-color: #f8f9fa;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: #fff;
        transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
        background-color: darken(var(--primary-color), 10%);
    }

    .card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-5px);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .fadeIn {
        animation: fadeIn 0.6s ease-in-out;
    }

    .transition-transform {
        transition: transform 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .listing-detail {
            padding: 15px;
        }
        .swiper-container {
            height: 300px; /* Reduce height for smaller screens */
        }
    }
</style>
{% endblock %}
